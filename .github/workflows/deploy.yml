name: Deploy FastAPI to Azure Function

on:
  push:
    branches:
      - staging
      - main

env:
  AZURE_RESOURCE_GROUP: rg-fastapi-${{ github.ref_name }}
  FUNCTION_APP_NAME: fastapi-func-${{ github.ref_name }}
  STORAGE_ACCOUNT_NAME: fastapistore${{ github.ref_name }}
  LOCATION: eastus
  PYTHON_VERSION: "3.10"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Resource Group (idempotent)
      run: |
        az group create --name $AZURE_RESOURCE_GROUP --location $LOCATION

    - name: Check if Storage Account exists
      id: check_storage
      run: |
        if az storage account show --name $FUNCTION_APP_NAME --resource-group $AZURE_RESOURCE_GROUP &> /dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Storage Account (if not exists)
      if: steps.check_storage.outputs.exists == 'false'
      run: |
        az storage account create \
          --name $FUNCTION_APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --location $LOCATION \
          --sku Standard_LRS \
          --kind StorageV2 \
          --access-tier Hot

    - name: Check if Function App exists
      id: check_func
      run: |
        if az functionapp show --name $FUNCTION_APP_NAME --resource-group $AZURE_RESOURCE_GROUP &> /dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Function App (if not exists)
      if: steps.check_func.outputs.exists == 'false'
      run: |
        az functionapp create \
          --name $FUNCTION_APP_NAME \
          --storage-account $STORAGE_ACCOUNT_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --runtime python \
          --runtime-version $PYTHON_VERSION \
          --functions-version 4 \
          --os-type Linux \
          --consumption-plan-location $LOCATION

    - name: Set Environment Variables
      run: |
        az functionapp config appsettings set \
          --name $FUNCTION_APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --settings ENV=${{ github.ref_name }}

    - name: Deploy Code
      uses: azure/functions-action@v1
      with:
        app-name: ${{ env.FUNCTION_APP_NAME }}
        package: .
